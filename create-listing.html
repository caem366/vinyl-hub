<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Vinyl Listing</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
    <script type="module" src="scripts/auth.js"></script>
    <script type="module" src="scripts/navbar.js"></script>
    <style>
        body {
            background-color: #343A40;  
            color: #f8f9fa; 
        }
        .container {
            max-width: 800px; 
        }
        input.form-control, select.form-select, textarea.form-control {
            background-color: #6C757D;
            color: #f8f9fa;
            border: 1px solid #adb5bd;
        }
        input.form-control::placeholder, textarea.form-control::placeholder {
            color: #ced4da;
        }
        input.form-control:focus, select.form-select:focus, textarea.form-control:focus {
            background-color: #6C757D;
            color: #f8f9fa;
            border-color: #adb5bd;
            box-shadow: none;
        }
        label {
            color: #f8f9fa;
        }

        .form-text{
            color: #ced4da; 
        }
    </style>
</head>
<body>

  
   
   
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="index.html">VinylHub</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="catalog.html">Shop Vinyls</a></li>
            <li class="nav-item">
              <a class="nav-link" href="create-listing.html" id="sellVinylLink">Sell Vinyl</a>
            </li>
            <li class="nav-item"><a class="nav-link" href="blog.html">Blog</a></li>
            <li class="nav-item"><a class="nav-link" href="checkout.html">Cart</a></li>
            <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
            <li class="nav-item dropdown" id="accountDropdown">
              <a class="nav-link dropdown-toggle" href="#" id="accountMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Account
              </a>
              <ul class="dropdown-menu" aria-labelledby="accountMenu">
                <li><a class="dropdown-item" href="manage-listings.html">Manage Listings</a></li>
                <li><a class="dropdown-item" href="manage-blog.html">Manage Blog Posts</a></li>
                <li><a class="dropdown-item" href="inbox.html">View Inbox</a></li>
                <li><a class="dropdown-item" href="wishlist.html" id="wishlistLink">Wishlist</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="logoutButton">Logout</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  
    <!-- Page Content -->
     <main>
    <div class="container mt-5">
        <h2 class="text-center mb-4">Create a Vinyl Listing</h2>
        <form id="createListingForm">
            <div class="mb-3">
                <label for="albumTitle" class="form-label">Album Title</label>
                <input type="text" class="form-control" id="albumTitle" placeholder="Enter album title" required>
            </div>

            <div class="mb-3">
                <label for="artist" class="form-label">Artist</label>
                <input type="text" class="form-control" id="artist" placeholder="Enter artist name" required>
            </div>

            <div class="mb-3">
                <label for="genre" class="form-label">Genre</label>
                <select class="form-select" id="genre" required>
                    <option value="">Select Genre</option>
                    <option value="Rock">Rock</option>
                    <option value="Jazz">Jazz</option>
                    <option value="Pop">Pop</option>
                    <option value="Alternative">Alternative</option>
                    <option value="Hip-Hop/Rap">Hip-Hop/Rap</option>
                    <option value="R&B/Soul">R&B/Soul</option>
                    <option value="Country">Country</option>
                    <option value="Electronic">Electronic</option>
                    <option value="Blues">Blues</option>
                    <option value="Experimental">Experimental</option>
                    <option value="Metal">Metal</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="releaseYear" class="form-label">Release Year</label>
                <select class="form-select" id="releaseYear" required>
                    <option value="">Select Year</option>
                    <!-- Generate years dynamically -->
                    <script>
                        const currentYear = new Date().getFullYear();
                        for (let year = currentYear; year >= 1900; year--) {
                            document.write(`<option value="${year}">${year}</option>`);
                        }
                    </script>
                </select>
            </div>

            <div class="mb-3">
                <label for="condition" class="form-label">Condition</label>
                <select class="form-select" id="condition" required>
                  
                    <option value="New">New</option>
                    <option value="Used">Used</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="price" class="form-label">Price ($)</label>
                <input type="number" class="form-control" id="price" placeholder="Enter price" required>
            </div>

            <div class="mb-3">
                <label for="albumCover" class="form-label">Upload Album Cover:</label>
                <input type="file" class="form-control" id="albumCover" accept="image/*">
                <div id="uploadedAlbumCover" class="mt-3">
                    <!-- Uploaded album cover preview will appear here -->
                </div>
            </div>

            <div class="mb-3">
                <label for="albumPhotos" class="form-label">Upload Additional Album Photos:</label>
                <input type="file" class="form-control" id="albumPhotos" accept="image/*" multiple>
                <small class="form-text" style="color: #ffffff;">You can upload multiple photos of the album.</small>
                <div id="uploadedPhotosList" class="mt-3">
                    <!-- List of uploaded photos will appear here -->
                </div>
            </div>

          

            <div class="mb-3">
                <label for="listingDescriptionEditor" class="form-label">Description:</label>
                <div id="listingDescriptionEditor" style="height: 200px; border: 1px solid #ced4da; border-radius: 4px; background-color: #ffffff; color: #000000;"></div>
            </div>

            <button type="submit" class="btn btn-primary w-100">Submit Listing</button>

            
        </form>
        <div id="albumPhotosCarousel" class="carousel slide mt-4" data-bs-ride="carousel">
          <div class="carousel-inner" id="albumPhotosPreview">
              <!-- Dynamically added images will appear here -->
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#albumPhotosCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#albumPhotosCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
          </button>
      </div>
    </div>
    <main></main>

    <!-- Footer -->
    <footer class="bg-dark text-white text-center py-3 mt-5">
        <p>&copy; 2025 VinylHub. All Rights Reserved.</p>
    </footer>

    <script type="module">
      import app from './config/firebase-config.js';
      import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js';

      const auth = getAuth(app);

      // Redirect unauthenticated users to the login page
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          alert('You must be logged in to access this page.');
          window.location.href = 'login.html';
        }
      });
    </script>
    <script type="module">
      import { requireAuth, updateNavigation } from './scripts/auth.js';
      requireAuth();
      updateNavigation();
    </script>
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script type="module" src="scripts/create-listing.js"></script>
    <script type="module" src="scripts/navbar.js"></script>
    <script type="module" src="scripts/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      import app from './config/firebase-config.js';
      import { getFirestore, collection, addDoc } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js';
      import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-storage.js';

      const db = getFirestore(app);
      const storage = getStorage(app);

      // Make dataTransfer available to the global scope
      window.dataTransfer = new DataTransfer(); 

      document.addEventListener('DOMContentLoaded', () => {
        const albumPhotosInput = document.getElementById('albumPhotos');
        const uploadedPhotosList = document.getElementById('uploadedPhotosList');

        albumPhotosInput.addEventListener('change', (event) => {
            const files = event.target.files;

            Array.from(files).forEach((file) => {
                // Add the file to the DataTransfer object
                window.dataTransfer.items.add(file);

                // Create a new preview item
                const reader = new FileReader();
                reader.onload = (e) => {
                    const photoItem = document.createElement('div');
                    photoItem.classList.add('d-flex', 'align-items-center', 'mb-2');
                    photoItem.innerHTML = `
                        <img src="${e.target.result}" alt="Uploaded Photo" class="me-2" style="width: 50px; height: 50px; object-fit: cover; border: 1px solid #adb5bd;">
                        <span class="me-auto">${file.name}</span>
                        <button type="button" class="btn btn-danger btn-sm">Remove</button>
                    `;
                    uploadedPhotosList.appendChild(photoItem);

                    // Add remove functionality
                    photoItem.querySelector('button').addEventListener('click', () => {
                        // Remove the file from DataTransfer
                        const updatedDataTransfer = new DataTransfer();
                        Array.from(window.dataTransfer.files).forEach((f) => {
                            if (f.name !== file.name) updatedDataTransfer.items.add(f);
                        });
                        window.dataTransfer.items.clear();
                        Array.from(updatedDataTransfer.files).forEach((f) => window.dataTransfer.items.add(f));

                        // Update the input's FileList
                        albumPhotosInput.files = window.dataTransfer.files;

                        // Remove the preview item
                        photoItem.remove();
                    });
                };
                reader.readAsDataURL(file);
            });

            // Update the input's FileList
            albumPhotosInput.files = window.dataTransfer.files;
        });
      });

      document.getElementById('createListingForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const albumTitle = document.getElementById('albumTitle').value;
        const artist = document.getElementById('artist').value;
        const genre = document.getElementById('genre').value;
        const releaseYear = document.getElementById('releaseYear').value;
        const condition = document.getElementById('condition').value;
        const price = parseFloat(document.getElementById('price').value);
        const description = quill.getText().trim(); // Get plain text from Quill editor
        const albumCover = document.getElementById('albumCover').files[0];
        const albumPhotos = window.dataTransfer.files; // Use the managed FileList

        try {
            let albumCoverUrl = '';
            if (albumCover) {
                const coverRef = ref(storage, `album-covers/${Date.now()}-${albumCover.name}`);
                await uploadBytes(coverRef, albumCover);
                albumCoverUrl = await getDownloadURL(coverRef);
            }

            const albumPhotoUrls = [];
            for (const photo of albumPhotos) {
                const photoRef = ref(storage, `album-photos/${Date.now()}-${photo.name}`);
                await uploadBytes(photoRef, photo);
                const photoUrl = await getDownloadURL(photoRef);
                albumPhotoUrls.push(photoUrl);
            }

            await addDoc(collection(db, 'listings'), {
                albumTitle,
                artist,
                genre,
                releaseYear,
                condition,
                price,
                description, // Save the plain text content
                albumCoverUrl,
                albumPhotoUrls, // Store all uploaded photo URLs
            });

            alert('Listing created successfully!');
            window.location.href = 'catalog.html';
        } catch (error) {
            console.error('Error creating listing:', error);
            alert('Failed to create listing. Please try again.');
        }
      });

      // Render the description as HTML
      function renderDescription(description) {
        const descriptionContainer = document.getElementById('descriptionContainer');
        descriptionContainer.innerHTML = description; // Render HTML content
      }
    </script>
    <script>
      // Initialize Quill editor
      const quill = new Quill('#listingDescriptionEditor', {
        theme: 'snow',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline'], // Formatting options
            [{ list: 'ordered' }, { list: 'bullet' }], // Lists
            [{ size: ['small', false, 'large', 'huge'] }], // Text size
            [{ font: [] }], // Font family
            ['link', 'image'], // Links and images
          ],
        },
      });

      document.getElementById('albumPhotos').addEventListener('change', (event) => {
        const files = event.target.files;
        const carouselInner = document.getElementById('albumPhotosPreview');
        carouselInner.innerHTML = ''; // Clear existing images

        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                carouselInner.innerHTML += `
                    <div class="carousel-item ${index === 0 ? 'active' : ''}">
                        <img src="${e.target.result}" class="d-block w-100" alt="Album Photo">
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        });
      });

      const albumCoverInput = document.getElementById('albumCover');
      const uploadedAlbumCover = document.getElementById('uploadedAlbumCover');

      albumCoverInput.addEventListener('change', (event) => {
          const file = event.target.files[0];
          uploadedAlbumCover.innerHTML = ''; // Clear existing preview

          if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                  const coverItem = document.createElement('div');
                  coverItem.classList.add('d-flex', 'align-items-center', 'mb-2');
                  coverItem.innerHTML = `
                      <img src="${e.target.result}" alt="Uploaded Album Cover" class="me-2" style="width: 50px; height: 50px; object-fit: cover; border: 1px solid #adb5bd;">
                      <span class="me-auto">${file.name}</span>
                      <button type="button" class="btn btn-danger btn-sm">Remove</button>
                  `;
                  uploadedAlbumCover.appendChild(coverItem);

                  // Add remove functionality
                  coverItem.querySelector('button').addEventListener('click', () => {
                      albumCoverInput.value = ''; // Clear the input
                      uploadedAlbumCover.innerHTML = ''; // Remove the preview
                  });
              };
              reader.readAsDataURL(file);
          }
      });
    </script>
</body>
</html>