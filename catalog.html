<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VinylHub - Browse Listings</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=swap" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script type="module" src="scripts/navbar.js"></script>
    <script type="module" src="scripts/auth.js"></script>
    <script type="module" src="config/firebase-config.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        h1 {
            font-weight: 700;
            margin-bottom: 30px; 
        }
        .sidebar {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-left: 5px; /* Reduced margin */
        }
        .sidebar input, .sidebar select {
            margin-bottom: 15px;
        }
        .listing-card {
            width: 350px;
            margin: 5px auto; /* Reduced margin */
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .listing-card img {
            height: 300px;
            object-fit: cover;
            border-radius: 12px 12px 0 0;
        }
        .listing-card .card-body {
            padding: 20px;
        }
        .listing-card h5 {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .listing-card p {
            font-size: 1.2rem;
        }
        .listing-card .card-body .btn-group {
            display: flex;
            justify-content: space-between;
            gap: 5px; 
        }
        .listing-card .card-body .btn-group button {
            flex: 1; 
            font-size: 0.8rem; 
            padding: 0px; 
        }
        .listing-card .card-body .btn-group button:not(:last-child) {
            margin-right: 5px; 
        }
        .some-class {
            filter: none;
        }
        .container {
            max-width: 1790px; 
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">VinylHub</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="catalog.html">Shop Vinyls</a></li>
                    <li class="nav-item"><a class="nav-link" href="create-listing.html">Sell Vinyl</a></li>
                    <li class="nav-item"><a class="nav-link" href="blog.html">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="checkout.html">Cart</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                    <li class="nav-item dropdown" id="accountDropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="accountMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">Account</a>
                        <ul class="dropdown-menu" aria-labelledby="accountMenu">
                            <li><a class="dropdown-item" href="manage-listings.html">Manage Listings</a></li>
                            <li><a class="dropdown-item" href="manage-blog.html">Manage Blog Posts</a></li>
                            <li><a class="dropdown-item" href="inbox.html">View Inbox</a></li>
                            <li><a class="dropdown-item" href="wishlist.html" id="wishlistLink">Wishlist</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutButton">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main>
    <!-- Main Content -->
    <div class="container mt-4">
        <h1 class="text-center mb-4">Vinyl</h1>
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3">
                <div class="sidebar" style="margin-left: 0;">
                    <h5>Search and Filters</h5>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search for vinyl records...">
                    <select id="genreFilter" class="form-select">
                        <option value="">All Genres</option>
                        <option value="Rock">Rock</option>
                        <option value="Jazz">Jazz</option>
                        <option value="Pop">Pop</option>
                        <option value="Alternative">Alternative</option>
                        <option value="Hip-Hop">Hip-Hop</option>
                        <option value="Hip-Hop/Rap">Hip-Hop/Rap</option>
                        <option value="R&B">R&B</option>
                        <option value="R&B/Soul">R&B/Soul</option>
                        <option value="Country">Country</option>
                        <option value="Electronic">Electronic</option>
                        <option value="Blues">Blues</option>
                        <option value="Soul">Soul</option>
                        <option value="Experimental">Experimental</option>
                        <option value="Metal">Metal</option>
                        <option value="Other">Other</option>
                    </select>
                    <select id="conditionFilter" class="form-select">
                        <option value="">All Conditions</option>
                        <option value="New">New</option>
                        <option value="Used">Used</option>
                    </select>
                    <select id="priceFilter" class="form-select">
                        <option value="">Sort by Price</option>
                        <option value="low-to-high">Low to High</option>
                        <option value="high-to-low">High to Low</option>
                    </select>
                </div>
            </div>

            <!-- Vinyl Listings -->
            <div class="col-md-9">
                <div class="row" id="listingsContainer">
                    <!-- Dynamically loaded listings will be inserted here -->
                </div>
                <!-- Pagination Controls -->
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center" id="paginationControls">
                        <!-- Pagination buttons will be dynamically added here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    </main> 

    <!-- Footer -->
    <div id="footer"></div>
    <footer class="bg-dark text-white text-center py-3 mt-5">
        <p>&copy; 2025 VinylHub. All Rights Reserved.</p>
    </footer>

    <script src="scripts/footer.js"></script>
    <script>
        async function buyNow(title, artist, price) {
            try {
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                cart.push({ title, artist, price });
                localStorage.setItem('cart', JSON.stringify(cart));
                alert(`${title} has been added to your cart!`);
                window.location.href = 'checkout.html';
            } catch (error) {
                console.error('Error adding item to cart:', error);
                alert('Failed to add item to cart. Please try again.');
            }
        }

        function makeOffer(title, artist) {
            alert(`Make an offer for ${title} by ${artist}`);
        }

        function viewDetails(listingId) {
            window.location.href = `product.html?id=${listingId}`;
        }

        const itemsPerPage = 8; // 4 items per row, 2 rows per page
        let currentPage = 1;

        async function loadListings() {
            try {
                const listingsContainer = document.getElementById('listingsContainer');
                const genreFilter = document.getElementById('genreFilter').value;
                const conditionFilter = document.getElementById('conditionFilter').value;
                const priceFilter = document.getElementById('priceFilter').value;

                listingsContainer.innerHTML = ''; // Clear existing content

                const response = await fetch('/api/listings'); // Fetch listings from the server
                if (!response.ok) {
                    if (response.status === 404) {
                        listingsContainer.innerHTML = '<p class="text-danger text-center">No listings found. Please check back later.</p>';
                        return;
                    }
                    throw new Error(`Failed to fetch listings: ${response.statusText}`);
                }

                let listings = await response.json();

                // Filter by genre
                if (genreFilter) {
                    listings = listings.filter(listing => listing.genre === genreFilter);
                }

                // Filter by condition
                if (conditionFilter) {
                    listings = listings.filter(listing => listing.condition === conditionFilter);
                }

                // Sort by price
                if (priceFilter === 'low-to-high') {
                    listings.sort((a, b) => a.price - b.price);
                } else if (priceFilter === 'high-to-low') {
                    listings.sort((a, b) => b.price - a.price);
                }

                renderListings(listings);
                renderPagination(listings);
            } catch (error) {
                console.error('Error loading listings:', error);
                const listingsContainer = document.getElementById('listingsContainer');
                listingsContainer.innerHTML = '<p class="text-danger text-center">Failed to load listings. Please try again later.</p>';
            }
        }

        function renderListings(listings) {
            const listingsContainer = document.getElementById('listingsContainer');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const currentListings = listings.slice(start, end);

            listingsContainer.innerHTML = currentListings.map(listing => `
                <div class="col-md-3 mb-4">
                    <div class="card catalog-card">
                        <img src="${listing.albumCoverUrl || 'https://via.placeholder.com/300x300?text=No+Image'}" class="card-img-top" alt="${listing.albumTitle}">
                        <div class="card-body">
                            <h5 class="card-title">${listing.albumTitle}</h5>
                            <p class="card-text">Artist: ${listing.artist}</p>
                            <p class="card-text">
                                Genre: 
                                <a href="catalog.html?genre=${encodeURIComponent(listing.genre)}" class="text-decoration-none" style="color: gray;">
                                    ${listing.genre}
                                </a>
                            </p>
                            <p class="card-text">Price: $${listing.price}</p>
                            <p class="card-text">Condition: ${listing.condition ? listing.condition[0].toUpperCase() + listing.condition.slice(1).toLowerCase() : ''}</p>
                            <div class="btn-group">
                                <button class="btn btn-primary w-50" onclick="buyNow('${listing.albumTitle}', '${listing.artist}', ${listing.price})">Buy Now</button>
                                <button class="btn btn-secondary w-50" onclick="viewDetails('${listing.id}')">View Details</button>
                                <button class="btn btn-secondary w-50" onclick="addToWishlist('${listing.id}', '${listing.albumTitle}', '${listing.artist}', '${listing.albumCoverUrl}')">Add to Wishlist</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderPagination(listings) {
            const paginationControls = document.getElementById('paginationControls');
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(listings.length / itemsPerPage);

            for (let i = 1; i <= totalPages; i++) {
                paginationControls.innerHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <button class="page-link" onclick="goToPage(${i})">${i}</button>
                    </li>
                `;
            }
        }

        function goToPage(page) {
            currentPage = page;
            loadListings(); // Reload listings for the selected page
        }

        document.getElementById('genreFilter').addEventListener('change', loadListings);
        document.getElementById('conditionFilter').addEventListener('change', loadListings);
        document.getElementById('priceFilter').addEventListener('change', loadListings);

        document.addEventListener('DOMContentLoaded', () => {
            loadListings(); // Initial load
        });
    </script>
    <script type="module">
        import { addToWishlist } from './scripts/wishlist.js';
        window.addToWishlist = addToWishlist; 
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="scripts/catalog.js"></script>
    <script type="module" src="scripts/wishlist.js"></script>
</body>
</html>